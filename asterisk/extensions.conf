[globals]
; General internal dialing options used in context Dial-Users.
; Only the timeout is defined here. See the Dial app documentation for
; additional options.
INTERNAL_DIAL_OPT=,30

[Hints]
; Allow dynamic hint creation for every extension.
exten = _11XX,hint,PJSIP/${EXTEN}

[Features]
; Extension to check user voicemail. We don't require the user to enter
; their pincode.
exten = 8000,1,Verbose(1, "User ${CALLERID(num)} dialed the voicemail feature.")
 same = n,VoiceMailMain(${CALLERID(num)}@example,s)
 same = n,Hangup()

; Exten to dial the main IVR internally.
exten = 1100,1,Verbose(1, "User ${CALLERID(num)} dialed the IVR.")
 same = n,Goto(Main-IVR,2565551100,1)

;Extension to enter a conference intended only for employees
exten = 6000,1,Verbose(1, "User ${CALLERID(num)} dialed the employee conference.")
 same = n,Confbridge(employees)
 same = n,Hangup()

;Extension to enter a conference intended for employees and customers
exten = 6500,1,Verbose(1, "User ${CALLERID(num)} dialed the employee/customer mixed conference.")
 same = n,Confbridge(mixed)
 same = n,Hangup()

[External-Features]
; Extension for users to remotely check voicemail. Here we require the caller to
; enter their mailbox and pincode.
exten = 2565551234,1,Verbose(1, "User ${CALLERID(num)} dialed into remote voicemail.")
 same = n,VoiceMailMain(example)
 same = n,Hangup()

; Extension to queue for sales.
; The queue has a 300 second timeout.
exten = 2565551200,1,Verbose(1, "User ${CALLERID(num)} dialed the sales queue.")
 same = n,Answer()
 same = n,Queue(sales,,,,300)
 same = n,Goto(operator,1)

; Extension to queue for a customer advocate.
; The queue has a 1200 second timeout.
exten = 2565551250,1,Verbose(1, "User ${CALLERID(num)} dialed the customer advocate queue.")
 same = n,Answer()
 same = n,Queue(customer_advocate,,,,1200)
 same = n,Goto(operator,1)

[Dialing-Errors]
; Handle any extensions dialed internally that don't otherwise exist.
; Comment out or remove this extension if you would rather have the calls
; ignored.
exten = _X.,1,Verbose(1, "User ${CALLERID(num)} dialed an invalid number.")
 same = n,Playback(pbx-invalid)
 same = n,Hangup()

[Internal-Setup]
; Here we capture internal calls to do anything we need to do before sending
; them onto all the possible internal locations. Such as disabling CDR on
; internal to internal calls.
exten = _X.,1,NoOp()
 same = n,Set(CDR_PROP(disable)=1)
 same = n,Goto(Internal-Main,${EXTEN},1)

; The Internal-Main context provides a way for internal callers to get access to most
; features and functions configured for them. External callers may be sent
; directly to some of the contexts you see included here, so the included
; contexts are not necessarily internal only.
[Internal-Main]
; The order of includes here is important for matching the right extensions.
include = Hints
include = Features
include = Dial-Users
include = Dialing-Errors

; Dial-Users handles calls to internal extensions.
; Calls coming into this context may be *external* or *internal* in origin.
[Dial-Users]
exten = _11XX,1,Verbose(1, "User ${CALLERID(num)} dialed ${EXTEN}.")
 same = n,Set(SAC_DIALED_EXTEN=${EXTEN})
 same = n,Gotoif($[${DEVICE_STATE(PJSIP/${EXTEN})} = BUSY]?dialed-BUSY,1:)
 same = n,Dial(PJSIP/${EXTEN}${INTERNAL_DIAL_OPT})
 same = n,Goto(dialed-${DIALSTATUS},1)

exten = dialed-NOANSWER,1,NoOp()
 same = n,Voicemail(${SAC_DIALED_EXTEN}@example,u)
 same = n,Hangup()

exten = dialed-BUSY,1,NoOp()
 same = n,Voicemail(${SAC_DIALED_EXTEN}@example,b)
 same = n,Hangup()

exten = dialed-CHANUNAVAIL,1,NoOp()
 same = n,Playback(pbx-invalid)
 same = n,Hangup()

exten = _dialed-.,1,Goto(dialed-NOANSWER,1)

exten = h,1,Hangup()

; Callers in the directory may dial 0 which will jump to the
; 'o' extension.
exten = o,1,Goto(1111)

; Outbound-Dial
;
; Before we dial, see if the extension matches our restricted number patterns.
; Note that this is a basic set of numbers which could incur a fee if dialed.
; The NANP includes many other numbers that you may want to block. If you feel
; it is necessary to block further number patterns you'll have to add them below
; or you may consider implementing a blacklist via methods beyond the scope of
; this example.
[Outbound-Dial]
exten = _011.,1,Hangup()
exten = _900NXXXXXX,1,Hangup()
exten = _1900NXXXXXX,1,Hangup()
exten = _976XXXX,1,Hangup()
exten = _NXX976XXXX,1,Hangup()
exten = _1NXX976XXXX,1,Hangup()
; Dial outbound through our SIP ITSP.
exten = _X.,1,Verbose(1, "Didn't match any restricted numbers, proceeding with outbound dial.")
 same = n,Set(CALLERID(num)=256555${CALLERID(num)})
 same = n,Dial(PJSIP/${EXTEN}@dcs-endpoint)
 same = n,Hangup()

; Calls from internal endpoints will enter into one of the two following
; contexts based on their dialing privilege.
[Local]
include = Internal-Setup

exten = _NXXXXXX,1,Goto(Outbound-Dial,1256${EXTEN},1)
exten = _256NXXXXXX,1,Goto(Outbound-Dial,1${EXTEN},1)
exten = _1256NXXXXXX,1,Goto(Outbound-Dial,${EXTEN},1)

[Long-Distance]
include = Local

exten = _NXXNXXXXXX,1,Goto(Outbound-Dial,1${EXTEN},1)
exten = _1NXXNXXXXXX,1,Goto(Outbound-Dial,${EXTEN},1)

; The DID-Extensions context captures inbound calls from our ITSP that have a
; DID number where the last four digits matches an internal extension.
[DID-Extensions]
exten = _25655511XX,1,Verbose(1, "External caller dialed inbound to DID ${EXTEN})")
 same = n,Goto(Dial-Users,${EXTEN:6},1)

; Our main IVR program for receiving inbound callers.
; The IVR script reads “Thank you for calling Super Awesome Company, Waldo’s
; premier provider of perfect products. If you know your party’s extension,
; you may dial it at any time. To establish a sales partnership, press one. To
; speak with a customer advocate, press two. For accounting and other
; receivables, press three. For a company directory, press four. For an
; operator, press zero.”
; demo-congrats is currently used as a placeholder.
[Main-IVR]
exten = 2565551100,1,Verbose(1, "New caller, ${CALLERID(num)} dialed into the IVR.")
 same = n,Answer()
 same = n(start),Background(basic-pbx-ivr-main)
 same = n,WaitExten(10)
 same = n,Background(basic-pbx-ivr-main)
 same = n,Hangup()

exten = 0,1,Verbose(1, "Caller ${CALLERID(num)} dialed the operator.")
 same = n,Goto(Dial-Users,1111,1)
exten = 1,1,Verbose(1, "Caller ${CALLERID(num)} dialed the Sales queue.")
 same = n,Goto(External-Features,2565551200,1)
exten = 2,1,Verbose(1, "Caller ${CALLERID(num)} dialed the Customer Experience queue.")
 same = n,Goto(External-Features,2565551250,1)
exten = 3,1,Verbose(1, "Caller ${CALLERID(num)} dialed Accounting and Receivables.")
 same = n,Goto(Dial-Users,1106,1)
exten = 4,1,Verbose(1, "Caller ${CALLERID(num)} dialed the directory.")
 same = n,Directory(example,Dial-Users)

exten = i,1,Playback(option-is-invalid)
 same = n,Goto(2565551100,start)

exten = t,1,Playback(are-you-still-there)
 same = n,Goto(2565551100,start)

; Calls from our ITSP SIP account arrive in DCS-Incoming. We should be careful
; to route calls very explicitly so as to avoid any security issues, such as
; accidentally giving outbound dial access to inbound callers.
;
; Each context includes extension pattern matching to match the inbound DID
; dialed appropriately.
[DCS-Incoming]
include = Main-IVR
include = DID-Extensions
include = External-Features

[voipms-outbound]
exten => _1NXXNXXXXXX,1,Dial(PJSIP/${EXTEN}@voipms)
exten => _1NXXNXXXXXX,n,Hangup()
exten => _NXXNXXXXXX,1,Dial(PJSIP/1${EXTEN}@voipms)
exten => _NXXNXXXXXX,n,Hangup()
exten => _NXXXXXX,1,Dial(PJSIP/1517${EXTEN}@voipms)
exten => _NXXXXXX,n,Hangup()

; Dial Cmd letters:
; r - Generate ring tone
; t - Allow called to transfer the call
; T - Allow the caller to transfer the call
; m - Provide music on hold to the caller until answered
; k - Allow the called to park the call
; K - Allow the caller to park the call
; H/h is to disconnect; not needed
; W/w is to record; already monitoring
; X/x is MixMonitor; already monitoring

[common-extensions]
include => parkedcalls

;exten => 2001,1,Answer()
;same => n,Set(CALLFILENAME=Ext2001-${STRFTIME(,,%Y-%m-%d-%H:%M)})
;same => n,Monitor(wav,${CALLFILENAME},m)
;same => n,Dial(PJSIP/ajphone,20,rtTmkK)
;same => n,Hangup()

;exten => 2002,1,Answer()
;same => n,Set(CALLFILENAME=Ext2002-${STRFTIME(,,%Y-%m-%d-%H:%M)})
;same => n,Monitor(wav,${CALLFILENAME},m)
;same => n,Dial(PJSIP/brittanyphone,20,rtTmkK)
;same => n,Hangup()

;exten => 2003,1,Answer()
;same => n,Set(CALLFILENAME=Ext2003-${STRFTIME(,,%Y-%m-%d-%H:%M)})
;same => n,Monitor(wav,${CALLFILENAME},m)
;same => n,Dial(PJSIP/ajlaptop,20,rtTmkK)
;same => n,Hangup()

;exten => 2004,1,Answer()
;same => n,Set(CALLFILENAME=Ext2004-${STRFTIME(,,%Y-%m-%d-%H:%M)})
;same => n,Monitor(wav,${CALLFILENAME},m)
;same => n,Dial(PJSIP/brittanylaptop,20,rtTmkK)
;same => n,Hangup()

;exten => 3100,1,Answer()
;same => n,Set(CALLFILENAME=Ext3100-${STRFTIME(,,%Y-%m-%d-%H:%M)})
;same => n,Monitor(wav,${CALLFILENAME},m)
;same = n,Dial(IAX2/asteriskpi:<ASTERISKPIIAXSECRET>@asteriskpi/3100)
;same = n,Hangup()

;exten => 3101,1,Answer()
;same => n,Set(CALLFILENAME=Ext3101-${STRFTIME(,,%Y-%m-%d-%H:%M)})
;same => n,Monitor(wav,${CALLFILENAME},m)
;same = n,Dial(IAX2/asteriskpi:<ASTERISKPIIAXSECRET>@asteriskpi/3101)
;same = n,Hangup()

;exten => 3102,1,Answer()
;same => n,Set(CALLFILENAME=Ext3102-${STRFTIME(,,%Y-%m-%d-%H:%M)})
;same => n,Monitor(wav,${CALLFILENAME},m)
;same = n,Dial(IAX2/asteriskpi:<ASTERISKPIIAXSECRET>@asteriskpi/3102)
;same = n,Hangup()

;exten => 3103,1,Answer()
;same => n,Set(CALLFILENAME=Ext3103-${STRFTIME(,,%Y-%m-%d-%H:%M)})
;same => n,Monitor(wav,${CALLFILENAME},m)
;same = n,Dial(IAX2/asteriskpi:<ASTERISKPIIAXSECRET>@asteriskpi/3103)
;same = n,Hangup()

;exten => 3104,1,Answer()
;same => n,Set(CALLFILENAME=Ext3104-${STRFTIME(,,%Y-%m-%d-%H:%M)})
;same => n,Monitor(wav,${CALLFILENAME},m)
;same = n,Dial(IAX2/asteriskpi:<ASTERISKPIIAXSECRET>@asteriskpi/3104)
;same = n,Hangup()

; From here: https://docs.asterisk.org/Configuration/Dialplan/Pattern-Matching
; Underscore (_) marks begin of a pattern
; Period (.) means 1 or more remaining characters
; Exclamation point (!) means 0 or more remaining characters

; Calls that route to AsteriskPI
exten => _2!,1,Answer()
same => n,Set(CALLFILENAME=Ext${EXTEN}-${STRFTIME(,,%Y-%m-%d-%H:%M)})
same => n,Monitor(wav,${CALLFILENAME},m)
same => n,Playback(hello-world)
same => n,Dial(IAX2/<ASTERISKPIIAXID>:<ASTERISKPIIAXSECRET>@asteriskpi.orians.org/${EXTEN})
same => n,Hangup()

; This is how to get an outside line
exten => _31415.,1,Dial(PJSIP/1${EXTEN:5}@voipms)
exten => _31415.,n,Playback(the-party-you-are-calling&is-curntly-unavail)
exten => _31415.,n,Hangup()

; Time
exten => 8463,1,Gosub(time)
same => n,Hangup()

; 6284 is 'math' on touchpad
exten => 6284,1,Answer
same => n,AGI(math.agi)
same => n,Hangup

include => time

[incoming-start]
;include => voipms-outbound
include => common-extensions

exten => s,1,Answer()
same => n,Background(extension)
same => n,WaitExten()
 
exten => i,1,Playback(pbx-invalid)
exten => i,n,Goto(incoming-start,s,1)
 
exten => t,1,Playback(vm-goodbye)
exten => t,n,Hangup()
 
exten => fax,1,Verbose(3,Incoming fax)
same => n,Answer()
same => n,Set(FILENAME=fax-${STRFTIME(,,%Y%m%d-%H%M%S)})
same => n,Set(FAXFILE=${FILENAME}.tif)
same => n,Set(FAX_DEST=/mnt/faxes)
same => n,Verbose(3,Receiving fax ${FAXFILE})
same => n,ReceiveFAX(${FAX_DEST}/${FAXFILE})
same => n,Verbose(3,- Fax receipt completed with status: ${FAXSTATUS})

; inbound context example for your DID numbers, do not add the number 1 in front

[voipms-inbound]
exten => 5173480350,1,Answer() ;your DID
same => n,Goto(incoming-start,s,1)

[mailserver-internal]
include => common-extensions

;exten => 1234,1,Answer()
;same = n,Wait(1)
;same = n,Playback(hello-world)
;same = n,Dial(IAX2/<AJHOMEDESKTOPIAXID>:<AJHOMEDESKTOPIAXSECRET>@ajsip.orians.org/68742)
;same = n,Hangup()

;exten => _3XXX,1,Dial(IAX2/<AJHOMEDESKTOPIAXID>:<AJHOMEDESKTOPIAXSECRET>@ajsip.orians.org/3${EXTEN})
;same => n,Hangup()

[fromvoipms]
; Make sure to include inbound prior to outbound because the _NXXNXXXXXX handler will match the incoming call and create a loop
include => voipms-inbound
include => voipms-outbound

[fromasteriskpiiax]
include => mailserver-internal
include => voipms-outbound

[fromraspberrypi400iax]
include => mailserver-internal
include => voipms-outbound

[fromajsipphone]
include => mailserver-internal
include => voipms-outbound

[frombrittanysipphone]
include => mailserver-internal
include => voipms-outbound

[fromajlaptop]
include => mailserver-internal
include => voipms-outbound

[frombrittanylaptop]
;include => mailserver-internal
;include => voipms-outbound

exten => 5555,1,Answer()
same => n,Goto(incoming-start,s,1)

[fromajhomedesktopiax]
include => voipms-outbound
